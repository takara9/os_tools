#!/bin/bash
function confirmation() {
    MSG="Yes または No をインプットしてください? [yes/no] : "
    echo -n $MSG

    while read response; do
	case $response in
            'yes' | 'Yes' | 'y' | 'Y' ) 
		echo "受け付けました。"
		return 1 ;;
            'no' | 'No' | 'n' | 'N' )
		echo "もう一度おねがいます。"
		return 0 ;;
            *)
		echo "yes/no y/n で、もう一度おねがします。"
		echo -n $MSG
	esac
    done
}

function keyboard_input() {
    while true
    do
	echo -n $1 " "
	read input_data
	echo $input_data " で良いですか？"
	confirmation
	if [ $? -eq 1 ]; then
	    RESULT=$input_data 
	    return 0
	elif [ $? -eq 0 ]; then
	    continue;
	fi
    done

}

# /sysimage/etc/fstab の編集
function edit_fstab() {
    ## バックアップ前のuuid リスト取得
    ## マージ
    ## 書き換え

}


# 以下に値をセットすると対話なしで実行します。
####################
CNT_NAME=
####################

if [ ! $CNT_NAME ]; then
    keyboard_input "オブジェクト・ストレージのコンテナ名をインプットしてください : " 
    if [ $? -eq 0 ]; then
	CNT_NAME=$RESULT
    fi
fi

FN=OS.txt
if [ ! -f $FN ]; then
    #./install_modules_os
    ./os_download.py $CNT_NAME OS.txt OS.txt
    if [ $? = 1 ]; then
	echo "コンテナが存在しません。終了します。"
	rm -f $FN
	exit
    fi
fi    


OS_DIST=`cat OS.txt`

if [ $OS_DIST = "CentOS" ]; then
    OS_RELEASE=centos-release
    ./os_download.py $CNT_NAME $OS_RELEASE $OS_RELEASE

    if [ -f $OS_RELEASE ]; then
	OS_VER=`cat $OS_RELEASE |sed -e 's/[^0-9.]//g'|awk '/^[0-9]/ { print int($1) }'`
    else 
	printf "Unknown OS\n"
	exit
    fi

else
    printf "Other Distribution\n"
    exit
fi

echo
echo $OS_DIST
echo $OS_VER
echo

######## CentOS common
mkdir /sysimage
mkdir /sysimage/boot



######## CentOS 6
if [ $OS_VER -eq 6 ];then

mount -t ext4  /dev/sda3 /sysimage
mount -t ext2  /dev/sda1 /sysimage/boot

cd /sysimage
rm -fr *

ln -s /root/os_tools/credentials.json .
/root/os_tools/os_restore.py $CNT_NAME sda3 | restore -rf -

cd /sysimage/boot
ln -s /root/os_tools/credentials.json .
/root/os_tools/os_restore.py $CNT_NAME sda1 | restore -rf -


# /sysimage/etc/fstab の編集
## バックアップ前のuuid リスト取得
## マージ
## 書き換え

####

ls -l /dev/disk/by-uuid/
cat /sysimage/etc/fstab
cat /sysimage/etc/grub.conf

# 
# vi /sysimage/etc/fstab
# vi /sysimage/etc/fstab
#
# chroot /sysimage
# export PATH=/bin:/sbin:$PATH
# MAKEDEV sda
# grub
# grub> root (hd0,0)
# setup (hd0)
# quit
# exit
# sync
# sync
# reboot
#


######## CentOS 7
elif [ $OS_VER -eq 7 ];then

mount -t xfs  /dev/sda3 /sysimage
mount -t xfs  /dev/sda1 /sysimage/boot

cd /sysimage
rm -fr *

ln -s /root/os_tools/credentials.json .
/root/os_tools/os_restore.py $CNT_NAME sda3 | xfsrestore - /sysimage

cd /sysimage/boot
ln -s /root/os_tools/credentials.json .
/root/os_tools/os_restore.py $CNT_NAME sda1 | xfsrestore - /sysimage/boot


# /sysimage/etc/fstab の編集

####

ls -l /dev/disk/by-uuid/
cat /sysimage/etc/fstab
cat /sysimage/etc/default/grub

# vi /etc/fstab 
# grub2-mkconfig
# grub2-install --boot-directory /sysimage/boot /dev/sda
# sync
# sync
# reboot
#


######## Other
else

printf "Abort! due to unknown OS"
exit

fi





