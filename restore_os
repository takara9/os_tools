#!/bin/bash

function confirmation() {
    MSG="Yes または No をインプットしてください? [yes/no] : "
    echo -n $MSG

    while read response; do
	case $response in
            'yes' | 'Yes' | 'y' | 'Y' ) 
		echo "受け付けました。"
		return 1 ;;
            'no' | 'No' | 'n' | 'N' )
		echo "もう一度おねがいます。"
		return 0 ;;
            *)
		echo "yes/no y/n で、もう一度おねがします。"
		echo -n $MSG
	esac
    done
}

function keyboard_input() {
    while true
    do
	echo -n $1 " "
	read input_data
	echo $input_data " で良いですか？"
	confirmation
	if [ $? -eq 1 ]; then
	    RESULT=$input_data 
	    return 0
	elif [ $? -eq 0 ]; then
	    continue;
	fi
    done

}


function create_device_diff_list() {
    ## バックアップ前のuuid リスト取得
    OLD_DEV_LIST=device_uuid_list_backup.txt
    ./os_download.py $CNT_NAME $OLD_DEV_LIST $OLD_DEV_LIST

    ## 現在のuuid リスト作成
    NEW_DEV_LIST=device_uuid_list_recovery.txt
    ls -l /dev/disk/by-uuid/ |awk '{print $9 " " $11}' | sed -e 's/..//' -e 's/..\/..\///' -e '/^ *$/d' > $NEW_DEV_LIST

    ## 新と旧の対比リスト作成
    DIF_DEV_LIST=device_uuid_list_history.txt
    rm -f $DIF_DEV_LIST

    while read line_old
    do
	old_dev=`echo $line_old |awk '{print $2}'`
	old_uuid=`echo $line_old |awk '{print $1}'`

	while read line_new
	do
	    new_dev=`echo $line_new |awk '{print $2}'`
	    new_uuid=`echo $line_new |awk '{print $1}'`
	    if [ $old_dev = $new_dev ]; then
		echo $old_dev $old_uuid $new_uuid >> $DIF_DEV_LIST
	    fi

	done < $NEW_DEV_LIST
    done < $OLD_DEV_LIST

}

# /sysimage/etc/fstab の編集
function edit_fstab() {
    $TARGET_FILE=/sysimage/etc/fstab
    ## fstab 書き換え??
    while read line
    do
	old_uuid=`echo $line |awk '{print $2}'`
	new_uuid=`echo $line |awk '{print $3}'`
	sed -i -e "s/$old_uuid/$new_uuid/g" $TARGET_FILE
    done < $DIF_DEV_LIST
}

# /sysimage/etc/grub の編集 for CentOS6
function edit_grub() {
    ## grub 書き換え??
    $TARGET_FILE=/sysimage/etc/grub.conf
    ## fstab 書き換え??
    while read line
    do
	old_uuid=`echo $line |awk '{print $2}'`
	new_uuid=`echo $line |awk '{print $3}'`
	sed -i -e "s/$old_uuid/$new_uuid/g" $TARGET_FILE
    done < $DIF_DEV_LIST
}


# 以下に値をセットすると対話なしで実行します。
####################
CNT_NAME=
####################

if [ ! $CNT_NAME ]; then
    keyboard_input "オブジェクト・ストレージのコンテナ名をインプットしてください : " 
    if [ $? -eq 0 ]; then
	CNT_NAME=$RESULT
    fi
fi

FN=OS.txt
if [ ! -f $FN ]; then
    #./install_modules_os
    ./os_download.py $CNT_NAME OS.txt OS.txt
    if [ $? = 1 ]; then
	echo "コンテナが存在しません。終了します。"
	rm -f $FN
	exit
    fi
fi    


OS_DIST=`cat OS.txt`

if [ $OS_DIST = "CentOS" ]; then
    OS_RELEASE=centos-release
    ./os_download.py $CNT_NAME $OS_RELEASE $OS_RELEASE

    if [ -f $OS_RELEASE ]; then
	OS_VER=`cat $OS_RELEASE |sed -e 's/[^0-9.]//g'|awk '/^[0-9]/ { print int($1) }'`
    else 
	printf "Unknown OS\n"
	exit
    fi

else
    printf "Other Distribution\n"
    exit
fi

echo
echo $OS_DIST
echo $OS_VER
echo

######## CentOS common
mkdir /sysimage
mkdir /sysimage/boot



######## CentOS 6
if [ $OS_VER -eq 6 ];then

mount -t ext4  /dev/sda3 /sysimage
mount -t ext2  /dev/sda1 /sysimage/boot

cd /sysimage
rm -fr *

ln -s /root/os_tools/credentials.json .
/root/os_tools/os_restore.py $CNT_NAME sda3 | restore -rf -

cd /sysimage/boot
ln -s /root/os_tools/credentials.json .
/root/os_tools/os_restore.py $CNT_NAME sda1 | restore -rf -


# /sysimage/etc/fstab の編集
# /sysimage/etc/grub の編集
create_device_diff_list
edit_fstab
edit_grub

####
#ls -l /dev/disk/by-uuid/
#cat /sysimage/etc/fstab
#cat /sysimage/etc/grub.conf

# 
# vi /sysimage/etc/fstab
# vi /sysimage/etc/fstab
#
# chroot /sysimage
# export PATH=/bin:/sbin:$PATH
# MAKEDEV sda
# grub
# grub> root (hd0,0)
# setup (hd0)
# quit
# exit
# sync
# sync
# reboot
#


######## CentOS 7
elif [ $OS_VER -eq 7 ];then

mount -t xfs  /dev/sda3 /sysimage
mount -t xfs  /dev/sda1 /sysimage/boot

cd /sysimage
rm -fr *

ln -s /root/os_tools/credentials.json .
/root/os_tools/os_restore.py $CNT_NAME sda3 | xfsrestore - /sysimage

cd /sysimage/boot
ln -s /root/os_tools/credentials.json .
/root/os_tools/os_restore.py $CNT_NAME sda1 | xfsrestore - /sysimage/boot


# /sysimage/etc/fstab の編集

####
create_device_diff_list
edit_fstab

#ls -l /dev/disk/by-uuid/
#cat /sysimage/etc/fstab
#cat /sysimage/etc/default/grub
# vi /etc/fstab 
grub2-mkconfig
grub2-install --boot-directory /sysimage/boot /dev/sda
sync
sync
# reboot
#


######## Other
else

printf "Abort! due to unknown OS"
exit

fi





